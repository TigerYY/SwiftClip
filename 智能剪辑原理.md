# 智能剪辑系统原理与实现

## 1. 整体处理流程

智剪蜂的智能剪辑系统通过以下步骤处理视频：

1. **语音识别**：使用OpenAI的Whisper模型将视频中的语音转换为带时间戳的文本
2. **语义分析**：分析转录文本，识别重要内容和冗余内容
3. **剪辑方案生成**：根据语义分析结果，生成符合目标时长的剪辑方案
4. **视频剪辑**：使用FFmpeg执行实际的视频剪辑操作

## 2. 关键技术实现

### 语音识别
```python
# 使用Whisper进行语音识别
result = self.whisper_model.transcribe(
    video_path,
    language="zh",  # 中文
    word_timestamps=True,  # 获取词级时间戳
    verbose=False
)
```

### 语义分析
系统通过以下方法分析内容重要性：
- 识别冗余词汇（如"呃"、"嗯"、"那个"等）
- 计算内容重要性得分（基于关键词、内容长度等）
- 对内容进行分类（数据、案例、结论、关键点等）

```python
def _calculate_importance_score(self, text: str) -> float:
    """计算内容重要性得分"""
    score = 0.5  # 基础分数
    
    # 关键词加分
    important_keywords = [
        "重要", "关键", "核心", "总结", "结论", "数据", 
        "案例", "例子", "方法", "技巧", "注意"
    ]
    
    for keyword in important_keywords:
        if keyword in text:
            score += 0.2
    
    # 长度加分（适中长度更重要）
    text_length = len(text.strip())
    if 10 <= text_length <= 100:
        score += 0.1
    
    return min(score, 1.0)  # 最高1.0分
```

### 剪辑方案生成
系统根据以下策略生成剪辑方案：
- 过滤掉冗余内容
- 按重要性排序选择片段
- 控制总时长不超过目标时长
- 最后按时间顺序重新排列

```python
# 过滤掉冗余内容
important_segments = [
    s for s in segments 
    if not s["is_redundant"] and s["importance_score"] > 0.3
]

# 按重要性排序
important_segments.sort(key=lambda x: x["importance_score"], reverse=True)

# 选择片段直到达到目标时长
selected_segments = []
total_duration = 0

for segment in important_segments:
    segment_duration = segment["end"] - segment["start"]
    if total_duration + segment_duration <= target_duration:
        selected_segments.append(segment)
        total_duration += segment_duration
    else:
        break

# 按时间顺序重新排列
selected_segments.sort(key=lambda x: x["start"])
```

### 视频剪辑
使用FFmpeg进行视频剪辑，包括：
1. 剪切每个选定的片段
2. 使用concat demuxer合并所有片段
3. 应用优化的编码参数控制文件大小

```python
# 剪切单个片段，使用更高的压缩率
(
    ffmpeg
    .input(input_path, ss=segment["start"], t=segment["end"] - segment["start"])
    .output(temp_file, vcodec='libx264', acodec='aac', 
            video_bitrate='1000k', audio_bitrate='128k',
            preset='medium', crf=23)
    .overwrite_output()
    .run(quiet=True)
)

# 使用concat demuxer并添加优化的编码参数
(
    ffmpeg
    .input(concat_file, format='concat', safe=0)
    .output(output_path, vcodec='libx264', acodec='aac',
            video_bitrate='1500k', audio_bitrate='128k',
            preset='medium', crf=23)
    .overwrite_output()
    .run(quiet=True)
)
```

## 3. 优化亮点

1. **M4芯片优化**：利用Apple M4芯片的MPS加速，提升AI推理速度
2. **智能内容筛选**：基于语义重要性自动选择保留内容
3. **视频压缩优化**：通过FFmpeg参数优化，平衡视频质量和文件大小
4. **硬件加速编码**：利用硬件加速提高视频处理效率

这套智能剪辑系统能够自动识别视频中的重要内容，去除冗余部分，生成更加精简、高效的视频，同时保持内容的连贯性和完整性。